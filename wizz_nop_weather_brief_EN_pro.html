<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wizz NOP Weather Brief — PDF → Management Report (EN)</title>

  <!-- PDF.js (client-side PDF text extraction) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"
          integrity="sha512-YpUVn5Rngt9N1Oe9e1ONh+G9wA8Iu1CgsG7Qe8W76P2QpL4X50iVhlr9vZ5l7Qh9vO0mT6rV6p4QK3cKcVZtWQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- DOCX export (client-side) -->
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>
  <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- PPTX export (client-side) -->
  <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

  <style>
    :root{
      --bg: #0a0f1c;
      --panel: rgba(12, 18, 32, 0.86);
      --text: #e9eefc;
      --muted: rgba(233, 238, 252, 0.72);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 12px 30px rgba(0,0,0,0.38);
      --radius: 14px;

      --wizz: #c5007a;
      --good: #2ee59d;
      --warn: #ffce3a;
      --bad: #ff4d6d;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    html, body { height:100%; margin:0; background: var(--bg); color: var(--text); font-family: var(--sans); }

    .app{
      display:grid;
      grid-template-columns: 440px 1fr;
      min-height: 100vh;
    }
    .panel{
      background: var(--panel);
      border-right: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 16px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(180deg, rgba(197,0,122,0.22), rgba(255,255,255,0.03));
      border-radius: 16px;
      margin-bottom: 14px;
    }
    .logo{
      width: 44px; height: 44px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), rgba(255,255,255,0.05)),
                  linear-gradient(135deg, rgba(197,0,122,0.85), rgba(122,162,255,0.55));
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 16px 28px rgba(0,0,0,0.35);
      position: relative;
      overflow: hidden;
    }
    .logo:after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, rgba(255,255,255,0.0), rgba(255,255,255,0.22), rgba(255,255,255,0.0));
      transform: rotate(12deg);
      animation: sheen 4.5s linear infinite;
    }
    @keyframes sheen{
      0%{ transform: translateX(-35%) rotate(12deg); }
      100%{ transform: translateX(35%) rotate(12deg); }
    }
    .brand h1{
      margin:0; font-size: 15px; letter-spacing: 0.04em;
      font-weight: 900;
    }
    .brand small{ display:block; margin-top: 4px; color: var(--muted); font-weight: 650; }
    .section{
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
    }
    .section h3{
      margin: 0 0 10px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin: 8px 0 6px;
    }
    input[type="url"], input[type="file"], textarea, select{
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--text);
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .row{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }
    .btn{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, background .12s ease, border-color .12s ease;
      letter-spacing: 0.01em;
      font-size: 13px;
      flex: 1 1 auto;
      text-align:center;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: rgba(197,0,122,0.24);
      border-color: rgba(197,0,122,0.52);
    }
    .btn.good{
      background: rgba(46,229,157,0.16);
      border-color: rgba(46,229,157,0.34);
    }
    .btn.warn{
      background: rgba(255,206,58,0.14);
      border-color: rgba(255,206,58,0.34);
    }
    .btn.danger{
      background: rgba(255,77,109,0.16);
      border-color: rgba(255,77,109,0.34);
    }

    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: rgba(233,238,252,0.86);
      font-weight: 750;
      font-size: 12px;
      line-height: 1.35;
    }
    .hint{
      color: rgba(233,238,252,0.70);
      font-size: 12px;
      line-height: 1.45;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      padding: 6px 10px;
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 11px;
      color: rgba(233,238,252,0.88);
    }
    .dot{ width:10px; height:10px; border-radius: 999px; display:inline-block; }
    .dot.good{ background: var(--good); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{  background: var(--bad); }

    /* Report area */
    .report{
      padding: 22px 22px 80px;
      background: radial-gradient(1200px 600px at 25% 5%, rgba(197,0,122,0.12), rgba(10,15,28,0.0)),
                  radial-gradient(900px 520px at 85% 20%, rgba(122,162,255,0.12), rgba(10,15,28,0.0));
      overflow:auto;
    }
    .sheet{
      max-width: 1140px;
      margin: 0 auto;
      background: rgba(8,12,22,0.54);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 18px 18px 20px;
    }
    .sheetHeader{
      display:flex;
      justify-content: space-between;
      gap: 14px;
      align-items:flex-start;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      padding-bottom: 12px;
      margin-bottom: 12px;
    }
    .sheetHeader h2{
      margin:0;
      font-size: 18px;
      font-weight: 950;
      letter-spacing: 0.02em;
    }
    .sheetHeader .meta{
      text-align:right;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(233,238,252,0.80);
      line-height: 1.35;
    }
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 12px 0;
    }
    .kpi{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
    }
    .kpi .k{
      color: rgba(233,238,252,0.72);
      font-weight: 850;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 11px;
    }
    .kpi .v{
      margin-top: 8px;
      font-size: 24px;
      font-weight: 950;
      letter-spacing: 0.01em;
    }
    .kpi .s{
      margin-top: 4px;
      color: rgba(233,238,252,0.70);
      font-weight: 700;
      font-size: 12px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
      margin-top: 12px;
    }
    .card{
      padding: 14px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
    }
    .card h4{
      margin:0 0 8px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: rgba(233,238,252,0.75);
      font-weight: 900;
    }
    .bullets{
      margin: 8px 0 0 18px;
      padding:0;
      color: rgba(233,238,252,0.88);
      font-weight: 700;
      line-height: 1.45;
      font-size: 13px;
    }
    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      font-family: var(--mono);
      font-size: 12px;
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      vertical-align: top;
    }
    .table th{
      text-align:left;
      color: rgba(233,238,252,0.82);
      font-weight: 950;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 11px;
      background: rgba(255,255,255,0.04);
    }
    .table tr:last-child td{ border-bottom: none; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 950;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.14);
      white-space: nowrap;
    }
    .badge.red{ background: rgba(255,77,109,0.16); border-color: rgba(255,77,109,0.40); }
    .badge.amb{ background: rgba(255,206,58,0.14); border-color: rgba(255,206,58,0.38); }
    .badge.gre{ background: rgba(46,229,157,0.14); border-color: rgba(46,229,157,0.34); }
    .badge.base{ background: rgba(197,0,122,0.16); border-color: rgba(197,0,122,0.40); }

    .raw{
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.35;
      color: rgba(233,238,252,0.86);
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px;
      max-height: 340px;
      overflow:auto;
    }

    .footerNote{
      margin-top: 12px;
      color: rgba(233,238,252,0.70);
      font-size: 12px;
      line-height: 1.45;
    }

    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; }
      .panel{ height:auto; position: relative; }
      .kpis{ grid-template-columns: 1fr 1fr; }
      .grid2{ grid-template-columns: 1fr; }
      .btn{ flex: 1 1 100%; }
    }
    @media print{
      body{ background: white; color: black; }
      .panel{ display:none !important; }
      .report{ padding: 0; background: white; }
      .sheet{ max-width: none; box-shadow: none; border: none; background: white; }
      .card{ background: white; border: 1px solid #ddd; }
      .table{ background: white; border: 1px solid #ddd; }
      .table th{ background: #f3f3f3; color: #111; }
      .raw{ background: #fafafa; color: #111; border: 1px solid #ddd; }
      .badge{ border: 1px solid #999; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="panel">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Wizz NOP Weather Brief</h1>
          <small>Client-side parsing → English management report (DOCX/PPTX export)</small>
        </div>
      </div>

      <div class="section">
        <h3>1) Wizz network inputs</h3>

        <label>Wizz-relevant stations (TXT, 1 ICAO per line)</label>
        <input id="icaoFile" type="file" accept=".txt,text/plain" />
        <div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnLoadIcao">Load ICAO list</button>
          <button class="btn" id="btnUseSample">Use sample list</button>
        </div>
        <div class="status" id="icaoStatus">No ICAO list loaded.</div>

        <label style="margin-top:12px;">Optional station mapping (CSV or JSON)</label>
        <div class="hint">
          CSV format: <span style="font-family:var(--mono)">ICAO,Name,Country,Type</span> (Type optional: BASE/OUTSTATION).<br/>
          JSON format: [{ "icao":"LHBP","name":"Budapest","country":"HU","type":"BASE" }, ...]
        </div>
        <input id="mapFile" type="file" accept=".csv,application/json,text/plain" />
        <div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnLoadMap">Load station mapping</button>
          <button class="btn" id="btnClearMap">Clear mapping</button>
        </div>
        <div class="status" id="mapStatus">No mapping loaded (ICAO-only display).</div>

        <label style="margin-top:12px;">Optional core bases list (TXT, 1 ICAO per line)</label>
        <input id="baseFile" type="file" accept=".txt,text/plain" />
        <div class="row" style="margin-top:10px;">
          <button class="btn good" id="btnLoadBases">Load bases</button>
          <button class="btn" id="btnUseBaseSample">Use sample bases</button>
        </div>
        <div class="status" id="baseStatus">No base list loaded.</div>

        <div class="hint" style="margin-top:8px;">
          Tip: Put <span style="font-family:var(--mono)">wizz_icaos.txt</span> + optional mapping files in your GitHub repo and load them here daily.
        </div>
      </div>

      <div class="section">
        <h3>2) NOP PDF input</h3>

        <label>Public PDF URL</label>
        <input id="pdfUrl" type="url" placeholder="https://.../YYYYMMDD_HHMM.pdf" />

        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnFetchPdf">Load PDF from URL</button>
          <button class="btn" id="btnSetToday">Set date to today (UTC)</button>
        </div>

        <label style="margin-top:12px;">Or upload PDF (if CORS blocks the URL)</label>
        <input id="pdfFile" type="file" accept="application/pdf" />
        <div class="row" style="margin-top:10px;">
          <button class="btn primary" id="btnLoadPdfFile">Load PDF from file</button>
          <button class="btn danger" id="btnClearPdf">Clear PDF</button>
        </div>

        <div class="status" id="pdfStatus">No PDF loaded.</div>
        <div class="hint" style="margin-top:8px;">
          GitHub Pages runs in-browser. If the PDF server blocks cross-origin fetch, use the file upload.
        </div>
      </div>

      <div class="section">
        <h3>3) Report generation & export</h3>

        <label>Minimum score threshold</label>
        <select id="minScore">
          <option value="0" selected>0 (include all)</option>
          <option value="3">3 (reduce noise)</option>
          <option value="5">5 (medium+ only)</option>
          <option value="7">7 (RED only)</option>
        </select>

        <label style="margin-top:10px;">Max hotspots</label>
        <select id="maxHot">
          <option value="10">10</option>
          <option value="15" selected>15</option>
          <option value="20">20</option>
        </select>

        <div class="row" style="margin-top:12px;">
          <button class="btn good" id="btnBuild">Build report</button>
          <button class="btn warn" id="btnCopy">Copy meeting summary</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="btnPrint">Print / Save as PDF</button>
          <button class="btn" id="btnDocx">Export DOCX</button>
          <button class="btn" id="btnPptx">Export PPTX (1 slide)</button>
        </div>

        <div class="status" id="buildStatus">Ready.</div>

        <div class="section" style="margin-top:12px;">
          <h3>Severity legend</h3>
          <div class="row">
            <span class="pill"><span class="dot bad"></span>RED (high disruption)</span>
            <span class="pill"><span class="dot warn"></span>AMBER (medium)</span>
            <span class="pill"><span class="dot good"></span>GREEN (low)</span>
          </div>
        </div>

        <div class="hint" style="margin-top:10px;">
          “Delay risk” is an evidence-based heuristic derived from drivers (winter/CB/wind/low-vis) and intensity signals (e.g., gusts, +TS, FZRA).
        </div>
      </div>
    </aside>

    <main class="report">
      <div class="sheet" id="reportSheet">
        <div class="sheetHeader">
          <div>
            <h2 id="rTitle">Wizz Air — NOP Weather / Delay Risk Brief</h2>
            <div style="margin-top:6px; color:rgba(233,238,252,0.78); font-weight:700;">
              Daily, Wizz-filtered overview of likely disruption drivers.
            </div>
          </div>
          <div class="meta">
            <div><strong>Generated:</strong> <span id="rGenerated">—</span></div>
            <div><strong>Source:</strong> <span id="rSource">—</span></div>
            <div><strong>Stations loaded:</strong> <span id="rStations">0</span></div>
            <div><strong>Mapping:</strong> <span id="rMapping">—</span></div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="k">Matched stations</div>
            <div class="v" id="kMatched">0</div>
            <div class="s">Airports Overview ∩ Wizz ICAO (after threshold)</div>
          </div>
          <div class="kpi">
            <div class="k">RED</div>
            <div class="v" id="kRed">0</div>
            <div class="s">High disruption risk</div>
          </div>
          <div class="kpi">
            <div class="k">AMBER</div>
            <div class="v" id="kAmber">0</div>
            <div class="s">Medium risk</div>
          </div>
          <div class="kpi">
            <div class="k">Primary drivers</div>
            <div class="v" id="kDrivers">—</div>
            <div class="s">Winter / Wind / Convective / Low-vis</div>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <h4>Executive summary</h4>
            <ul class="bullets" id="execBullets">
              <li>Load your ICAO list and the daily NOP PDF, then build the report.</li>
              <li>If URL fetch fails due to CORS, use file upload.</li>
              <li>This is a leadership summary, not a substitute for validated operational MET inputs.</li>
            </ul>
          </div>
          <div class="card">
            <h4>Recommended operational posture</h4>
            <ul class="bullets" id="recoBullets">
              <li>Winter ops: de-icing readiness; protect turnarounds at exposed stations; review alternates.</li>
              <li>Wind/CB windows: anticipate approach limits; holding/diversion sensitivity; capacity variability.</li>
              <li>Network: monitor ATFM/capacity; protect critical rotations and first-wave performance.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4>Top hotspots (Wizz-relevant)</h4>
          <div style="overflow:auto;">
            <table class="table" id="hotTable">
              <thead>
                <tr>
                  <th>Severity</th>
                  <th>Delay risk</th>
                  <th>ICAO</th>
                  <th>Station</th>
                  <th>Time</th>
                  <th>Drivers</th>
                  <th>Snippet</th>
                </tr>
              </thead>
              <tbody id="hotBody">
                <tr><td colspan="7" style="color:rgba(233,238,252,0.70); font-weight:700;">No data.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4>En-route / airspace signals (extracted)</h4>
          <div class="raw" id="enrouteBox">—</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4>NOP synopsis (extracted)</h4>
          <div class="raw" id="synopsisBox">—</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h4>Parsing diagnostics</h4>
          <div class="raw" id="debugBox">Ready.</div>
        </div>

        <div class="footerNote">
          Disclaimer: leadership summary for situational awareness. For operational decisions, use validated MET/ATM sources and company procedures.
        </div>
      </div>
    </main>
  </div>

<script>
  // PDF.js worker
  pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";

  // State
  let WIZZ_ICAOS = new Set();
  let CORE_BASES = new Set();
  let STATION_MAP = new Map(); // ICAO -> {name,country,type}
  let PDF_TEXT = "";
  let PDF_SOURCE = "";
  let PDF_LOADED_AT = null;

  const SAMPLE_ICAOS = [
    "LHBP","LOWW","LKPR","EPWA","EPGD","EDDH","EDDF","EDDM","EHAM","LFPG","LIRF","LEBL","LPPT","LPMA",
    "LROP","LBSF","LTFM","LGAV","LCLK","GCLP","GMMN"
  ];
  const SAMPLE_BASES = ["LHBP","EPWA","LTFM","LGAV","LBSF","LROP"];

  // Helpers
  const $ = (id) => document.getElementById(id);

  function nowLocal(){
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function todayUtcYmd(){
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const day = String(d.getUTCDate()).padStart(2,"0");
    return `${y}${m}${day}`;
  }
  function setStatus(id, msg){ $(id).textContent = msg; }
  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }
  function uniq(arr){ return [...new Set(arr)]; }

  function parseIcaoText(text){
    const out = [];
    const lines = text.split(/\r?\n/).map(l => l.trim().toUpperCase()).filter(Boolean);
    for (const l of lines){
      const m = l.match(/\b[A-Z]{4}\b/);
      if (m) out.push(m[0]);
    }
    return uniq(out);
  }

  function parseCsvMapping(text){
    // ICAO,Name,Country,Type
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      if (/^ICAO\b/i.test(line)) continue;
      const parts = line.split(",").map(x => x.trim());
      if (parts.length < 2) continue;
      const icao = (parts[0] || "").toUpperCase();
      if (!/^[A-Z]{4}$/.test(icao)) continue;
      out.push({
        icao,
        name: parts[1] || "",
        country: parts[2] || "",
        type: (parts[3] || "").toUpperCase()
      });
    }
    return out;
  }

  async function readFileText(file){ return await file.text(); }

  // PDF extraction: rebuild "lines" by Y coordinate
  async function extractTextFromPdfArrayBuffer(buf){
    const doc = await pdfjsLib.getDocument({ data: buf }).promise;
    let full = [];
    for (let p=1; p<=doc.numPages; p++){
      const page = await doc.getPage(p);
      const content = await page.getTextContent();
      const items = content.items
        .filter(it => it.str && it.str.trim().length)
        .map(it => ({ str: it.str, x: it.transform[4], y: it.transform[5] }))
        .sort((a,b) => (b.y - a.y) || (a.x - b.x));

      let line = [];
      let currentY = null;

      const flush = () => {
        if (!line.length) return;
        // Join with spacing; small heuristic to reduce over-joining
        const s = line.map(x => x.str).join(" ").replace(/\s+/g," ").trim();
        if (s) full.push(s);
        line = [];
      };

      for (const it of items){
        if (currentY === null) currentY = it.y;
        if (Math.abs(it.y - currentY) > 2.6){
          flush();
          currentY = it.y;
        }
        line.push(it);
      }
      flush();
      full.push("");
    }
    return full.join("\n");
  }

  async function loadPdfFromUrl(url){
    const r = await fetch(url, { mode: "cors" });
    if (!r.ok) throw new Error("HTTP " + r.status);
    return await r.arrayBuffer();
  }

  // NOP-specific parsing (heuristics)
  function extractSection(text, startLabel, endLabels){
    const t = text.replace(/\r/g, "");
    const idx = t.toLowerCase().indexOf(startLabel.toLowerCase());
    if (idx < 0) return "";
    let end = t.length;
    for (const e of endLabels){
      const j = t.toLowerCase().indexOf(e.toLowerCase(), idx + startLabel.length);
      if (j >= 0) end = Math.min(end, j);
    }
    return t.slice(idx, end).trim();
  }

  function extractSynopsis(text){
    const endLabels = ["Airports Overview", "AIRPORTS OVERVIEW", "En-route", "En route", "En-Route"];
    let sec = extractSection(text, "Synopsis", endLabels);
    if (sec) return sec;
    sec = extractSection(text, "SYNOPSIS", endLabels);
    if (sec) return sec;
    const ao = text.toLowerCase().indexOf("airports overview");
    if (ao > 0) return text.slice(0, Math.min(ao, 2600)).trim();
    return text.slice(0, 2600).trim();
  }

  function extractEnroute(text){
    // Capture en-route related paragraphs for ATM impact cues (CAT, CB tops, jet, etc.)
    const sec = extractSection(text, "En-route", ["Disclaimer", "Legend", "Definitions", "Airports Overview"]);
    if (sec) return sec;
    const sec2 = extractSection(text, "En route", ["Disclaimer", "Legend", "Definitions", "Airports Overview"]);
    if (sec2) return sec2;
    // Fallback: try to locate "CAT" and take a slice
    const idx = text.toUpperCase().indexOf("CAT");
    if (idx > 0) return text.slice(Math.max(0, idx-600), Math.min(text.length, idx+1200)).trim();
    return "";
  }

  function parseAirportsOverview(text){
    const sec = extractSection(text, "Airports Overview", ["En-route", "En route", "En-Route", "Disclaimer", "Legend", "Definitions"]);
    const block = sec || text;

    // Preferred: item starts on a new line: ICAO + time-window (e.g. 0106/0110)
    const re = /(\b[A-Z]{4}\b)\s+(\d{4}\/\d{4})\s+([\s\S]*?)(?=\n[A-Z]{4}\s+\d{4}\/\d{4}\s+|\n\s*$)/g;
    let m;
    const items = [];
    while ((m = re.exec(block)) !== null){
      items.push({
        icao: m[1].trim(),
        time: m[2].trim(),
        snippet: m[3].replace(/\s+/g," ").trim(),
        raw: `${m[1].trim()} ${m[2].trim()} ${m[3].replace(/\s+/g," ").trim()}`
      });
    }

    // Fallback: if newlines collapsed
    if (!items.length){
      const flat = block.replace(/\n+/g," ").replace(/\s+/g," ");
      const re2 = /(\b[A-Z]{4}\b)\s+(\d{4}\/\d{4})\s+(.+?)(?=\s+[A-Z]{4}\s+\d{4}\/\d{4}\s+|$)/g;
      while ((m = re2.exec(flat)) !== null){
        items.push({ icao: m[1], time: m[2], snippet: m[3].trim(), raw: `${m[1]} ${m[2]} ${m[3].trim()}` });
      }
    }
    return items;
  }

  // Risk tagging / scoring (heuristic)
  function scoreAndTag(item){
    const s = (item.raw || "").toUpperCase();
    let score = 0;
    const tags = [];

    // Convective
    if (/\bTS\b/.test(s) || /\+TS/.test(s) || /\bCB\b/.test(s)){
      score += 4; tags.push("CONVECTIVE");
    }

    // Winter
    if (/\bFZRA\b/.test(s)){ score += 5; tags.push("FZRA"); }
    if (/\bBLSN\b/.test(s) || /\bDRSN\b/.test(s)){ score += 4; tags.push("BLOWING/DRIFT SN"); }
    if (/\+SN\b/.test(s)){ score += 4; tags.push("HEAVY SN"); }
    else if (/\bSN\b/.test(s)){ score += 3; tags.push("SN"); }

    // Low visibility / fog
    if (/\bFZFG\b/.test(s) || /\bFG\b/.test(s)){ score += 4; tags.push("FOG"); }
    if (/\bBR\b/.test(s) && !/\bFZRA\b/.test(s)){ score += 1; tags.push("BR"); }
    if (/\b(0\d{3}|1\d{3})\b/.test(s)){ // crude: very low vis numbers sometimes appear
      score += 1; tags.push("LOW VIS");
    }

    // Wind / gusts
    const gust = s.match(/G(\d{2,3})KT/);
    if (gust){
      const g = parseInt(gust[1],10);
      if (g >= 45) score += 4;
      else if (g >= 35) score += 3;
      else if (g >= 28) score += 2;
      else score += 1;
      tags.push("WIND GUSTS");
    } else {
      const wind = s.match(/\b(\d{3}|VRB)\d{2,3}KT\b/);
      if (wind){ score += 1; tags.push("WIND"); }
    }

    // Precip intensity
    if (/\+RA\b/.test(s) || /\bSHRA\b/.test(s) || /\bSHSNRA\b/.test(s)){ score += 2; tags.push("HEAVY PRECIP"); }
    else if (/\bRA\b/.test(s) || /\bSH\b/.test(s)){ score += 1; tags.push("PRECIP"); }

    // Interaction bonus
    if (tags.includes("CONVECTIVE") && (tags.includes("WIND GUSTS") || tags.includes("WIND"))) score += 1;
    if (tags.includes("FZRA") && (tags.includes("WIND GUSTS") || tags.includes("WIND"))) score += 1;

    // Core base weighting (disruption propagates)
    const isBase = CORE_BASES.has(item.icao);
    if (isBase) score += 1;

    score = Math.min(score, 10);

    let sev = "GREEN";
    if (score >= 7) sev = "RED";
    else if (score >= 4) sev = "AMBER";

    const delayRisk = (sev === "RED") ? "HIGH" : (sev === "AMBER" ? "MEDIUM" : "LOW");
    return { score, sev, tags: uniq(tags), delayRisk, isBase };
  }

  function driversFromItems(items){
    const cnt = { conv:0, wind:0, winter:0, lowvis:0 };
    for (const it of items){
      const t = it.tags || [];
      if (t.includes("CONVECTIVE")) cnt.conv++;
      if (t.includes("WIND GUSTS") || t.includes("WIND")) cnt.wind++;
      if (t.includes("SN") || t.includes("HEAVY SN") || t.includes("BLOWING/DRIFT SN") || t.includes("FZRA")) cnt.winter++;
      if (t.includes("FOG") || t.includes("LOW VIS")) cnt.lowvis++;
    }
    const parts = [];
    if (cnt.winter) parts.push("Winter");
    if (cnt.wind) parts.push("Wind");
    if (cnt.conv) parts.push("Convective");
    if (cnt.lowvis) parts.push("Low-vis");
    return parts.length ? parts.join(" / ") : "—";
  }

  function stationLabel(icao){
    const m = STATION_MAP.get(icao);
    if (!m) return { station: "—", country: "—", type: "" };
    const station = m.name || "—";
    const country = m.country || "—";
    const type = (m.type || "").toUpperCase();
    return { station, country, type };
  }

  function buildExecutiveBullets(matched){
    const bullets = [];
    const reds = matched.filter(x => x.sev === "RED").length;
    const ambs = matched.filter(x => x.sev === "AMBER").length;
    const basesHit = matched.filter(x => x.isBase).map(x => x.icao);

    if (!matched.length){
      bullets.push("No Wizz-matching items found in Airports Overview at the selected threshold.");
      return bullets;
    }

    const top = matched.slice(0, 6);
    const topTxt = top.map(x => {
      const st = stationLabel(x.icao);
      const name = st.station !== "—" ? ` — ${st.station}` : "";
      return `${x.icao}${name} (${x.sev}/${x.delayRisk}; ${x.tags.slice(0,2).join("/") || "—"})`;
    }).join("; ");
    bullets.push(`Top impacted stations: ${topTxt}.`);

    if (reds){
      bullets.push(`RED disruption risk present at ${reds} station(s). Expect elevated reactionary delay potential and rotation knock-on risk.`);
    } else {
      bullets.push("No RED-level stations at the current threshold; expect localized variability rather than network-wide disruption.");
    }

    if (ambs){
      bullets.push(`${ambs} AMBER station(s) suggest moderate capacity/ground variability; protect critical turns where feasible.`);
    }

    const drv = driversFromItems(matched);
    bullets.push(`Primary disruption drivers: ${drv}.`);

    if (basesHit.length){
      bullets.push(`Core base exposure detected: ${uniq(basesHit).slice(0,10).join(", ")}. Prioritize base protection and wave integrity.`);
    }

    return bullets;
  }

  // Copy summary
  async function copyMeetingSummary(){
    const execLis = Array.from($("execBullets").querySelectorAll("li")).map(li => "- " + li.innerText);
    const topRows = Array.from($("hotBody").querySelectorAll("tr")).slice(0, 10).map(tr => {
      const tds = tr.querySelectorAll("td");
      if (tds.length < 7) return null;
      const sev = tds[0].innerText.split("\n")[0].trim();
      const risk = tds[1].innerText.split("\n")[0].trim();
      const icao = tds[2].innerText.trim();
      const station = tds[3].innerText.trim();
      const time = tds[4].innerText.trim();
      const drivers = tds[5].innerText.trim();
      const snip = tds[6].innerText.trim();
      return `- ${icao} | ${sev}/${risk} | ${time} | ${drivers} | ${station} | ${snip}`;
    }).filter(Boolean);

    const text = [
      $("rTitle").textContent,
      `Generated: ${$("rGenerated").textContent}`,
      `Source: ${PDF_SOURCE || "—"}`,
      "",
      "Executive summary:",
      ...execLis,
      "",
      "Top hotspots:",
      ...(topRows.length ? topRows : ["- (no data)"]),
    ].join("\n");

    await navigator.clipboard.writeText(text);
    setStatus("buildStatus", "Meeting summary copied to clipboard.");
  }

  // Export DOCX
  async function exportDocx(){
    if (!$("rGenerated").textContent || $("rGenerated").textContent === "—"){
      setStatus("buildStatus", "Build the report first.");
      return;
    }
    try{
      const docx = window.docx;
      const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType } = docx;

      const title = $("rTitle").textContent;
      const gen = $("rGenerated").textContent;
      const src = PDF_SOURCE || "—";

      const exec = Array.from($("execBullets").querySelectorAll("li")).map(li => li.innerText);
      const reco = Array.from($("recoBullets").querySelectorAll("li")).map(li => li.innerText);
      const synopsis = $("synopsisBox").textContent || "";
      const enroute = $("enrouteBox").textContent || "";

      // Table rows
      const rows = Array.from($("hotBody").querySelectorAll("tr")).map(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds.length < 7) return null;
        return Array.from(tds).map(td => td.innerText.replace(/\s+/g," ").trim());
      }).filter(Boolean);

      const makeCell = (text) => new TableCell({
        children: [new Paragraph({ children: [new TextRun({ text: text || "" })] })],
      });

      const tableRows = [
        new TableRow({
          children: ["Severity","Delay risk","ICAO","Station","Time","Drivers","Snippet"].map(h =>
            new TableCell({
              children: [new Paragraph({ children:[ new TextRun({ text:h, bold:true }) ] })],
            })
          )
        }),
        ...rows.map(r => new TableRow({ children: r.map(c => makeCell(c)) }))
      ];

      const doc = new Document({
        sections: [{
          properties: {},
          children: [
            new Paragraph({ text: title, heading: HeadingLevel.HEADING_1 }),
            new Paragraph({ children: [new TextRun({ text: `Generated: ${gen} | Source: ${src}`, italics: true })] }),
            new Paragraph({ text: "Executive summary", heading: HeadingLevel.HEADING_2 }),
            ...exec.map(x => new Paragraph({ text: "• " + x })),
            new Paragraph({ text: "Recommended operational posture", heading: HeadingLevel.HEADING_2 }),
            ...reco.map(x => new Paragraph({ text: "• " + x })),
            new Paragraph({ text: "Top hotspots (Wizz-relevant)", heading: HeadingLevel.HEADING_2 }),
            new Table({ rows: tableRows, width: { size: 100, type: WidthType.PERCENTAGE } }),
            new Paragraph({ text: "En-route / airspace signals (extracted)", heading: HeadingLevel.HEADING_2 }),
            new Paragraph({ text: enroute }),
            new Paragraph({ text: "NOP synopsis (extracted)", heading: HeadingLevel.HEADING_2 }),
            new Paragraph({ text: synopsis }),
            new Paragraph({ text: "Disclaimer: leadership summary for situational awareness. Operational decisions require validated MET/ATM sources and company procedures.", spacing: { before: 240 } }),
          ]
        }]
      });

      const blob = await Packer.toBlob(doc);
      saveAs(blob, `wizz_nop_weather_brief_${todayUtcYmd()}.docx`);
      setStatus("buildStatus", "DOCX exported.");
    } catch(e){
      console.error(e);
      setStatus("buildStatus", "DOCX export failed (browser/library blocked). Use Print/PDF as fallback.");
    }
  }

  // Export PPTX (1 slide)
  async function exportPptx(){
    if (!$("rGenerated").textContent || $("rGenerated").textContent === "—"){
      setStatus("buildStatus", "Build the report first.");
      return;
    }
    try{
      const pptx = new PptxGenJS();
      pptx.layout = "LAYOUT_WIDE";
      const slide = pptx.addSlide();

      // Background
      slide.background = { color: "0A0F1C" };

      // Header bar
      slide.addShape(pptx.ShapeType.roundRect, { x:0.3, y:0.25, w:12.7, h:0.7, fill:{ color:"1A1730", transparency: 10 }, line:{ color:"FFFFFF", transparency: 85 } });
      slide.addText($("rTitle").textContent, { x:0.5, y:0.35, w:12.3, h:0.4, fontFace:"Calibri", fontSize:20, bold:true, color:"FFFFFF" });
      slide.addText(`Generated: ${$("rGenerated").textContent} | Source: ${PDF_SOURCE || "—"}`, { x:0.5, y:0.72, w:12.3, h:0.25, fontFace:"Consolas", fontSize:10, color:"CFCFEA" });

      // Executive summary box
      slide.addShape(pptx.ShapeType.roundRect, { x:0.3, y:1.15, w:7.2, h:3.25, fill:{ color:"141A2D", transparency: 10 }, line:{ color:"FFFFFF", transparency: 88 } });
      slide.addText("EXECUTIVE SUMMARY", { x:0.5, y:1.28, w:6.8, h:0.3, fontFace:"Calibri", fontSize:12, bold:true, color:"CFCFEA" });

      const exec = Array.from($("execBullets").querySelectorAll("li")).map(li => "• " + li.innerText);
      slide.addText(exec.join("\n"), { x:0.5, y:1.6, w:6.9, h:2.7, fontFace:"Calibri", fontSize:14, color:"FFFFFF", valign:"top" });

      // Hotspots box
      slide.addShape(pptx.ShapeType.roundRect, { x:7.65, y:1.15, w:5.35, h:6.7, fill:{ color:"141A2D", transparency: 10 }, line:{ color:"FFFFFF", transparency: 88 } });
      slide.addText("TOP HOTSPOTS", { x:7.85, y:1.28, w:5.0, h:0.3, fontFace:"Calibri", fontSize:12, bold:true, color:"CFCFEA" });

      const rows = Array.from($("hotBody").querySelectorAll("tr")).slice(0, 9).map(tr => {
        const tds = tr.querySelectorAll("td");
        if (tds.length < 7) return null;
        const sev = tds[0].innerText.split("\n")[0].trim();
        const risk = tds[1].innerText.split("\n")[0].trim();
        const icao = tds[2].innerText.trim();
        const time = tds[4].innerText.trim();
        const drv = tds[5].innerText.trim().split(",").slice(0,2).join(",");
        return `${icao} | ${sev}/${risk} | ${time} | ${drv}`;
      }).filter(Boolean);

      slide.addText(rows.length ? rows.join("\n") : "(no data)", { x:7.85, y:1.58, w:5.0, h:6.1, fontFace:"Consolas", fontSize:11, color:"FFFFFF", valign:"top" });

      // Recommendations box
      slide.addShape(pptx.ShapeType.roundRect, { x:0.3, y:4.55, w:7.2, h:3.3, fill:{ color:"141A2D", transparency: 10 }, line:{ color:"FFFFFF", transparency: 88 } });
      slide.addText("RECOMMENDED POSTURE", { x:0.5, y:4.68, w:6.8, h:0.3, fontFace:"Calibri", fontSize:12, bold:true, color:"CFCFEA" });
      const reco = Array.from($("recoBullets").querySelectorAll("li")).map(li => "• " + li.innerText);
      slide.addText(reco.join("\n"), { x:0.5, y:5.0, w:6.9, h:2.75, fontFace:"Calibri", fontSize:13, color:"FFFFFF", valign:"top" });

      await pptx.writeFile({ fileName: `wizz_nop_weather_brief_${todayUtcYmd()}.pptx` });
      setStatus("buildStatus", "PPTX exported.");
    } catch(e){
      console.error(e);
      setStatus("buildStatus", "PPTX export failed (browser/library blocked). Use Print/PDF as fallback.");
    }
  }

  // Build report
  function buildReport(){
    if (!WIZZ_ICAOS.size){
      setStatus("buildStatus", "Load your Wizz ICAO list first.");
      return;
    }
    if (!PDF_TEXT){
      setStatus("buildStatus", "Load the NOP PDF first.");
      return;
    }

    const minScore = parseInt($("minScore").value, 10) || 0;
    const maxHot = parseInt($("maxHot").value, 10) || 15;

    const synopsis = extractSynopsis(PDF_TEXT);
    const enroute = extractEnroute(PDF_TEXT);
    const overview = parseAirportsOverview(PDF_TEXT);

    let matched = overview
      .filter(it => WIZZ_ICAOS.has(it.icao))
      .map(it => ({ ...it, ...scoreAndTag(it) }))
      .filter(it => it.score >= minScore);

    matched.sort((a,b) => (b.score - a.score) || (a.icao.localeCompare(b.icao)));

    // KPIs
    $("rGenerated").textContent = nowLocal();
    $("rSource").textContent = PDF_SOURCE || "—";
    $("rStations").textContent = String(WIZZ_ICAOS.size);
    $("rMapping").textContent = STATION_MAP.size ? `${STATION_MAP.size} mapped` : "none";

    const reds = matched.filter(x => x.sev === "RED").length;
    const ambs = matched.filter(x => x.sev === "AMBER").length;

    $("kMatched").textContent = String(matched.length);
    $("kRed").textContent = String(reds);
    $("kAmber").textContent = String(ambs);
    $("kDrivers").textContent = driversFromItems(matched);

    // Executive bullets
    const bullets = buildExecutiveBullets(matched);
    $("execBullets").innerHTML = bullets.map(b => `<li>${escapeHtml(b)}</li>`).join("");

    // Recommendations: customize if winter dominates
    const drv = driversFromItems(matched);
    const reco = [];
    if (drv.includes("Winter")){
      reco.push("Winter ops: confirm de-icing capacity, towing/stand plans, runway contamination monitoring; add turnaround buffers where exposed.");
    }
    if (drv.includes("Wind")){
      reco.push("Wind: monitor gust thresholds and crosswind exposure; anticipate approach/ground handling variability and capacity degradation.");
    }
    if (drv.includes("Convective")){
      reco.push("Convective: plan for holding and tactical reroutes; set diversion posture early for exposed islands/coastal stations.");
    }
    if (drv.includes("Low-vis")){
      reco.push("Low-visibility: expect LVO and sequencing constraints; protect first-wave departures.");
    }
    reco.push("Network: monitor ATFM/capacity; protect critical rotations; prioritize base wave integrity if bases are exposed.");
    $("recoBullets").innerHTML = reco.map(r => `<li>${escapeHtml(r)}</li>`).join("");

    // Hotspots table
    const tbody = $("hotBody");
    const top = matched.slice(0, maxHot);

    if (!top.length){
      tbody.innerHTML = `<tr><td colspan="7" style="color:rgba(233,238,252,0.70); font-weight:700;">No Wizz-matching items found (at this threshold).</td></tr>`;
    } else {
      tbody.innerHTML = top.map(it => {
        const cls = it.sev === "RED" ? "red" : (it.sev === "AMBER" ? "amb" : "gre");
        const riskCls = it.delayRisk === "HIGH" ? "red" : (it.delayRisk === "MEDIUM" ? "amb" : "gre");
        const drivers = it.tags.join(", ");
        const st = stationLabel(it.icao);
        const station = st.station !== "—" ? `${st.station}${st.country && st.country !== "—" ? " ("+st.country+")" : ""}` : "—";
        const baseBadge = it.isBase ? `<span class="badge base" style="margin-left:8px;">BASE</span>` : "";
        return `<tr>
          <td><span class="badge ${cls}">${escapeHtml(it.sev)}</span>${baseBadge}<div style="margin-top:6px;color:rgba(233,238,252,0.72);font-weight:800;">score ${it.score}</div></td>
          <td><span class="badge ${riskCls}">${escapeHtml(it.delayRisk)}</span></td>
          <td style="font-weight:950;">${escapeHtml(it.icao)}</td>
          <td style="font-family: var(--sans); font-weight: 750;">${escapeHtml(station)}</td>
          <td>${escapeHtml(it.time)}</td>
          <td>${escapeHtml(drivers || "—")}</td>
          <td style="max-width:520px; white-space: normal; font-family: var(--sans); font-weight: 700; line-height:1.35;">
            ${escapeHtml(it.snippet || "")}
          </td>
        </tr>`;
      }).join("");
    }

    $("synopsisBox").textContent = synopsis || "—";
    $("enrouteBox").textContent = enroute || "—";

    // Diagnostics
    const dbg = [
      `PDF loaded: ${PDF_LOADED_AT || "—"}`,
      `Overview items parsed: ${overview.length}`,
      `Wizz ICAOs loaded: ${WIZZ_ICAOS.size}`,
      `Station mapping entries: ${STATION_MAP.size}`,
      `Core bases loaded: ${CORE_BASES.size}`,
      `Matched after threshold: ${matched.length}`,
      "",
      "If 'Overview items parsed' is 0, try PDF upload instead of URL (text extraction differences)."
    ].join("\n");
    $("debugBox").textContent = dbg;

    setStatus("buildStatus", "Report built.");
  }

  // UI events
  $("btnUseSample").addEventListener("click", () => {
    WIZZ_ICAOS = new Set(SAMPLE_ICAOS);
    setStatus("icaoStatus", `Loaded sample: ${WIZZ_ICAOS.size} ICAO codes`);
    $("rStations").textContent = String(WIZZ_ICAOS.size);
  });

  $("btnLoadIcao").addEventListener("click", async () => {
    const f = $("icaoFile").files[0];
    if (!f){ setStatus("icaoStatus", "No TXT selected."); return; }
    const text = await readFileText(f);
    const list = parseIcaoText(text);
    WIZZ_ICAOS = new Set(list);
    setStatus("icaoStatus", `Loaded: ${WIZZ_ICAOS.size} ICAO codes`);
    $("rStations").textContent = String(WIZZ_ICAOS.size);
  });

  $("btnUseBaseSample").addEventListener("click", () => {
    CORE_BASES = new Set(SAMPLE_BASES);
    setStatus("baseStatus", `Loaded sample bases: ${CORE_BASES.size}`);
  });

  $("btnLoadBases").addEventListener("click", async () => {
    const f = $("baseFile").files[0];
    if (!f){ setStatus("baseStatus", "No TXT selected."); return; }
    const text = await readFileText(f);
    const list = parseIcaoText(text);
    CORE_BASES = new Set(list);
    setStatus("baseStatus", `Loaded bases: ${CORE_BASES.size}`);
  });

  $("btnClearMap").addEventListener("click", () => {
    STATION_MAP.clear();
    setStatus("mapStatus", "Mapping cleared.");
    $("rMapping").textContent = "none";
  });

  $("btnLoadMap").addEventListener("click", async () => {
    const f = $("mapFile").files[0];
    if (!f){ setStatus("mapStatus", "No mapping file selected."); return; }
    const name = (f.name || "").toLowerCase();
    const text = await readFileText(f);
    try{
      let entries = [];
      if (name.endsWith(".json")){
        const data = JSON.parse(text);
        entries = Array.isArray(data) ? data : [];
      } else {
        entries = parseCsvMapping(text);
      }
      STATION_MAP.clear();
      for (const e of entries){
        if (!e.icao) continue;
        STATION_MAP.set(e.icao.toUpperCase(), {
          name: e.name || "",
          country: e.country || "",
          type: (e.type || "").toUpperCase()
        });
      }
      setStatus("mapStatus", `Mapping loaded: ${STATION_MAP.size} entries`);
      $("rMapping").textContent = `${STATION_MAP.size} mapped`;
    } catch(err){
      console.error(err);
      setStatus("mapStatus", "Mapping load failed (invalid CSV/JSON).");
    }
  });

  $("btnFetchPdf").addEventListener("click", async () => {
    const url = $("pdfUrl").value.trim();
    if (!url){ setStatus("pdfStatus", "Enter a PDF URL."); return; }
    setStatus("pdfStatus", "Fetching PDF…");
    try{
      const buf = await loadPdfFromUrl(url);
      PDF_TEXT = await extractTextFromPdfArrayBuffer(buf);
      PDF_SOURCE = url;
      PDF_LOADED_AT = nowLocal();
      setStatus("pdfStatus", "PDF loaded from URL.");
    } catch(e){
      console.error(e);
      setStatus("pdfStatus", "URL load failed (likely CORS). Download and use PDF upload instead.");
    }
  });

  $("btnLoadPdfFile").addEventListener("click", async () => {
    const f = $("pdfFile").files[0];
    if (!f){ setStatus("pdfStatus", "No PDF selected."); return; }
    setStatus("pdfStatus", "Parsing PDF…");
    try{
      const buf = await f.arrayBuffer();
      PDF_TEXT = await extractTextFromPdfArrayBuffer(buf);
      PDF_SOURCE = f.name;
      PDF_LOADED_AT = nowLocal();
      setStatus("pdfStatus", "PDF loaded from file.");
    } catch(e){
      console.error(e);
      setStatus("pdfStatus", "PDF parsing failed.");
    }
  });

  $("btnClearPdf").addEventListener("click", () => {
    PDF_TEXT = ""; PDF_SOURCE = ""; PDF_LOADED_AT = null;
    setStatus("pdfStatus", "No PDF loaded.");
    $("synopsisBox").textContent = "—";
    $("enrouteBox").textContent = "—";
    $("debugBox").textContent = "Ready.";
  });

  $("btnSetToday").addEventListener("click", () => {
    // Heuristic: replace YYYYMMDD patterns in the URL with today's UTC date.
    // If multiple matches exist, replace all.
    const url = $("pdfUrl").value.trim();
    if (!url){ setStatus("pdfStatus", "Paste a URL first, then click Set date."); return; }
    const ymd = todayUtcYmd();
    const updated = url.replace(/\b20\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])\b/g, ymd);
    $("pdfUrl").value = updated;
    setStatus("pdfStatus", `URL date set to ${ymd} (UTC) if pattern was found.`);
  });

  $("btnBuild").addEventListener("click", buildReport);
  $("btnCopy").addEventListener("click", copyMeetingSummary);
  $("btnPrint").addEventListener("click", () => window.print());
  $("btnDocx").addEventListener("click", exportDocx);
  $("btnPptx").addEventListener("click", exportPptx);
</script>
</body>
</html>
